= Adding Spring Cloud Config to Boot Application

In this lab we'll utilize Spring Boot and Spring Cloud to make our UI Application more resilient.  We'll leverage Spring Cloud Circuit Breaker to configure our application behavior when our downstream dependencies are not available.  Finally, we'll use the circuit break dashboard to view metrics of the circuit breaker we implemented, which will be auto-provisioned within Cloud Foundry Pivotal Spring Cloud Services.

== Define a Circuit Breaker within the _UI Application_

. These features are added by adding _spring-cloud-services-starter-circuit-breaker_ to the classpath.  Open you Maven POM found here: */cloud-native-spring/pom.xml*.  Add the following spring cloud services dependency:
+
[source, xml]
---------------------------------------------------------------------
<dependency>
    <groupId>io.pivotal.spring.cloud</groupId>
	<artifactId>spring-cloud-services-starter-circuit-breaker</artifactId>
	<version>1.1.0.M3</version>
</dependency>
---------------------------------------------------------------------

. The first thing we need to add to our application is an @EnableCircuitBreaker annotation to the Spring Boot application.  Add this annotation below the other ones on the CloudNativeSpringUIApplication declaration in the class _io.pivotal.CloudNativeSpringUIApplication_ (/cloud-native-spring-ui/src/main/java/io/pivotal/CloudNativeSpringUIApplication.java):
+
[source, java, numbered]
---------------------------------------------------------------------
@SpringBootApplication
@EnableFeignClients
@EnableDiscoveryClient
@EnableCircuitBreaker
public class CloudNativeSpringUiApplication {
---------------------------------------------------------------------

. When we introduced an @FeignClient into our application we were only required to provide an interface.  Now we'll create an implementation of our *CityClient* interface that can be used as our Circuit Breaker fallback logic.  Add the following code to the bottom (but still within the class definition) of _io.pivotal.CloudNativeSpringUIApplication_ (/cloud-native-spring-ui/src/main/java/io/pivotal/CloudNativeSpringUIApplication.java):
+
[source, java, numbered]
---------------------------------------------------------------------
@Component
public static class ClientFallback implements CityClient {

	@Override
	public Resources getCities() {
		//We'll just return an empty response
		return new Resources(Collections.EMPTY_LIST);
	}
}
---------------------------------------------------------------------

. The last thing we need to do is define the method around which we'll wrap the CircuitBreaker.  Typically we'd use an @HystrixCommand annotation on a specific implementation.  However, a @FeignClient automatically wraps all methods of the interface with a Hystrix Circuit Breaker.  We simply need to add an additional attribute in the @FeignClient annotation that points to our fallback implementation.  Add the following attribute to @FeignClient annotation in _io.pivotal.CloudNativeSpringUIApplication_ (/cloud-native-spring-ui/src/main/java/io/pivotal/CloudNativeSpringUIApplication.java):
+
[source, java, numbered]
---------------------------------------------------------------------
@FeignClient(value = "cloud-native-spring", fallback = ClientFallback.class)
---------------------------------------------------------------------

== Deploy and test application

. Build the application
+
[source,bash]
---------------------------------------------------------------------
$ mvn clean package
---------------------------------------------------------------------

. Push application into Cloud Foundry
+
[source,bash]
---------------------------------------------------------------------
$ cf push -f manifest.yml
---------------------------------------------------------------------

. Test your application by navigating to the root URL of the application.  If the dependent cities REST service is still stopped, you should simply see a blank table.  Remember that last time you received a nasty exception in the browser?  Now your Circuit Breaker fallback method is automatically called and the fallback behavior is executed.
+
image::images/empty.jpg[]

. From a commandline start the cloud-native-spring microservice (the original city service, not the new UI)
+
[source,bash]
---------------------------------------------------------------------
$ cf start cloud-native-spring
---------------------------------------------------------------------

. Refresh the UI app and you should once again see a table listing the first page of cities.
+
image::../lab05/images/ui.jpg[]
