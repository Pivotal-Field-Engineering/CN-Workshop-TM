= Adding Service Registration and Discover with Spring Cloud

In this lab we'll utilize Spring Boot and Spring Cloud to configure our application register itself with a service registry.  To do this we'll also need to provision an instance of a Eureka service registry using Pivotal Cloudfoundry Spring Cloud Services.  We'll also add a simple client application that looks up our application from the service registry and makes requests to our Cities service.

== Update _Cloud-Native-Spring_ Boot Application to Register with Eureka

. These features are added by adding _spring-cloud-services-starter-service-registry_ to the classpath.  Open your Maven POM found here: */cloud-native-spring/pom.xml*.  Add the following spring cloud services dependency:
+
[source, xml]
---------------------------------------------------------------------
<dependency>
    <groupId>io.pivotal.spring.cloud</groupId>
	<artifactId>spring-cloud-services-starter-service-registry</artifactId>
	<version>1.1.0.BUILD-SNAPSHOT</version>
</dependency>
---------------------------------------------------------------------
+

. Thanks to Spring Cloud instructing your application to register with Eureka is as simple as adding a single annotation to your app! Add an @EnableDiscoveryClient annotation to the class _io.pivotal.CloudNativeSpringApplication_ (/cloud-native-spring/src/main/java/io/pivotal/CloudNativeApplication.java):
+
[source, java, numbered]
---------------------------------------------------------------------
@SpringBootApplication
@RestController
@EnableJpaRepositories
@EnableDiscoveryClient
@Import(RepositoryRestMvcAutoConfiguration.class)
public class CloudNativeSpringApplication {
---------------------------------------------------------------------
+
Completed:
+
[source,java,numbered]
---------------------------------------------------------------------
package io.pivotal;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.data.rest.RepositoryRestMvcAutoConfiguration;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.context.annotation.Import;
import org.springframework.data.jpa.repository.config.EnableJpaRepositories;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@SpringBootApplication
@RestController
@EnableJpaRepositories
@EnableDiscoveryClient
@Import(RepositoryRestMvcAutoConfiguration.class)
public class CloudNativeSpringApplication {

	public static void main(String[] args) {
		SpringApplication.run(CloudNativeSpringApplication.class, args);
	}

	@Value("${greeting:Hola}")
	private String _greeting;

	@RequestMapping("/")
	public String hello() {
		return _greeting + " World!";
	}
}
---------------------------------------------------------------------

== Create Spring Cloud Service Registry instance and deploy application

. Now that our application is ready to read registry with an Eureka instance, we need to deploy one!  This can be done through cloudfoundry using the services marketplace.  Previously we did this through the Marketplace UI, but this time we will use the Cloudfoundry CLI (though we could also do this through the UI:
+
[source,bash]
---------------------------------------------------------------------
$ cf create-service p-service-registry standard service-registry
---------------------------------------------------------------------

. After you create the service registry instance navigate to your cloudfoundry space in the Apps Manager UI and refresh the page.  You should now see the newly create service registry intance.  Select the manage link to view the registry dashboard.  Note that there are not any registered applications at the moment:
+
image::images/registry1.jpg[]

. We will now bind our application to our service-registry within our Cloudfoundry deployment manifest.  Add thee additional reference to a the service to the bottom of */cloud-native-spring/manifest.yml* in the services list:
+
[source, yml]
---------------------------------------------------------------------
  services:
  - config-server
  - service-registry
---------------------------------------------------------------------
+
Complete:
+
[source, yml]
---------------------------------------------------------------------
---
applications:
- name: cloud-native-spring
  host: cloud-native-spring-${random-word}
  memory: 512M
  instances: 1
  path: ./target/cloud-native-spring-0.0.1-SNAPSHOT.jar
  buildpack: java_buildpack_offline
  timeout: 180
  env:
    CF_TARGET: https://api.cfpoc2.internal.t-mobile.com
  services:
  - config-server
  - service-registry
---------------------------------------------------------------------

== Deploy and test application

. Build the application
+
[source,bash]
---------------------------------------------------------------------
$ mvn clean package
---------------------------------------------------------------------

. Push application into Cloud Foundry
+
[source,bash]
---------------------------------------------------------------------
$ cf push -f manifest.yml
---------------------------------------------------------------------

. If we now test our application URLs we will no change.  However, if we view the Service Registry dashboard (accessible from the _manage_ link in Apps Manager) you will see that a service named cloud-native-spring has registered:
+
image::images/registry2.jpg[]

. Next we'll create a simple UI application that will read the service registry to discover the location of our cities REST service and connect.

== Create another Spring Boot Project as a Client Application

. Browse to https://start.spring.io

. Generate a Maven Project with Spring Boot 1.3 (if this version is unavailable then get the latest 1.3.X version, but no SNAPSHOTS).

. Fill out the *Project metadata* fields as follows:
+
Group:: +io.pivotal+
Artifact:: +cloud-native-spring-ui+

. In the dependencies section, add the following:
+
*Web* *Rest Repositories* *JPA* *H2* *MySQL* *Actuator* *Eureka Discovery*

. Click the _Generate Project_ button. Your browser will download a zip file.

. Copy then unpack the downloaded zip file to *CN-Workshop-TM/labs/lab05/cloud-native-spring-ui*
+
Your directory structure should now look like:
+
[source, bash]
---------------------------------------------------------------------
CN-Workshop-TM:
├── labs
│   ├── lab01
│   │   ├── cloud-native-spring
│   ├── lab05
│   │   ├── cloud-native-spring-ui
---------------------------------------------------------------------

. Import the project’s pom.xml into your editor/IDE of choice.